{% extends '@OroUI/Default/index.html.twig' %}

{% block pageTitle %}Nylas Email Sync
{% endblock %}

{% block content %}
	<div class="nylas-container">
		<div class="header-container">
			<div>
				<h4 class="header-title">Nylas Email Sync</h4>
				<p class="lead">Manage your email accounts and sync folders with Nylas.</p>
			</div>
			{% if emailOrigins %}
				<div class="text-right">
					<a href="{{ path('nylas_auth') }}" class="btn btn-primary" title="Connect a new email account. You'll be redirected to authenticate; after success, the account will appear here.">
						<i class="fa fa-plus"></i>
						Connect New Account
					</a>
				</div>
			{% endif %}
		</div>
		<div id="status-message">
			{% for flashMessage in app.session.flashbag.get('token_saved') %}
				<div class="alert alert-success flash-message">{{ flashMessage }}</div>
			{% endfor %}

			{% for flashMessage in app.session.flashbag.get('success') %}
				<div class="alert alert-success flash-message">{{ flashMessage }}</div>
			{% endfor %}

			{% for flashMessage in app.session.flashbag.get('error') %}
				<div class="alert alert-danger flash-message">{{ flashMessage }}</div>
			{% endfor %}
		</div>

		<div class="container-fluid section-margin nylas-content">

			{% if emailOrigins is empty %}
				<div class="container-fluid section-margin text-center">
					<h5>{{ 'extension.title' | trans }}</h5>
					<p class="lead">Please connect your email account to sync folders with Nylas.</p>
					<a href="{{ path('nylas_auth') }}" class="btn btn-primary" title="Connect a new email account. You'll be redirected to authenticate; after success, the account will appear here.">
						Connect New Email Account
					</a>
				</div>
			{% else %}
				<h5>Connected Email Accounts</h5>
				<div class="table-responsive">
					<table class="table table-striped table-bordered table-shadow">
						<thead>
							<tr>
								<th scope="col">Email Address</th>
								<th scope="col" class="text-center">Default Account</th>
								<th scope="col" class="text-center">Actions</th>
								<th scope="col" class="text-center">Status</th>
							</tr>
						</thead>
						<tbody>
							{% for emailOrigin in emailOrigins %}
								<tr>
									<td>{{ emailOrigin.email }}</td>
									<td class="text-center">
										{% if emailOrigin.isDefault %}
											<span class="badge badge-success">Yes</span>
										{% else %}
											<span class="badge badge-secondary">No</span>
										{% endif %}
									</td>
									<td class="text-center">
										{% if not emailOrigin.isDefault %}
											<form action="{{ path('nylas_set_default_account', {'id': emailOrigin.id}) }}" method="post" style="display: inline;">
												<input type="hidden" name="_csrf_token" value="{{ csrf_token('set_default_account') }}">
												<button type="submit" class="btn btn-primary btn-sm" title="Set this account as default. On page load, this accountâ€™s folder list will be shown by default.">
													Mark as Default
												</button>
											</form>
										{% else %}
											<button class="btn btn-primary btn-sm btn-disabled" disabled aria-disabled="true">
												Default Account
											</button>
										{% endif %}
									</td>
									<td class="text-center">
										<input
										type="checkbox" class="form-check-input status-toggle" role="switch" id="emailStatusSwitch{{ emailOrigin.id }}" data-id="{{ emailOrigin.id }}" data-status="{{ emailOrigin.activeStatus ? 'true' : 'false' }}" {{ emailOrigin.activeStatus ? 'checked' : '' }} title="{{ emailOrigin.activeStatus ? 'Deactive this account' : 'Active this account' }}">
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				<div class="row mt-5">
					{% set activeEmailOrigins = emailOrigins|filter(emailOrigin => emailOrigin.activeStatus|length != 0 and emailOrigin.activeStatus != false) %}
					<div class="form-group">
						<h5 for="emailOriginSelect">Select Email Account:</h5>
						<select class="span12" id="emailOriginSelect" onchange="window.location.href='{{ url('nylas_email_folder_list', {'id': ''}) }}/'.concat(this.value, '?_t=', Date.now())" style="max-width: 500px;">

							{% if activeEmailOrigins is empty %}
								<option selected>No Active Account Found</option>
							{% else %}
								{% for emailOrigin in activeEmailOrigins %}
									<option value="{{ emailOrigin.id }}" {% if emailOrigin.id == selectedEmailOriginId %} selected {% endif %}>
										{{ emailOrigin.email }}
										{% if emailOrigin.isDefault %}(Default)
										{% endif %}
									</option>
								{% endfor %}
							{% endif %}

						</select>
					</div>
					<div class="ml-4">
						{% if emailFolders is not empty %}
							<div class="container-fluid section-margin">
								<h5>Mailbox Folders:
									{{ email }}</h5>
								{% for flashMessage in app.session.flashbag.get('success') %}
									<div class="alert alert-success flash-message">{{ flashMessage }}</div>
								{% endfor %}
								<form method="post" action="{{ path('nylas_email_folder_list', {'id': selectedEmailOriginId}) }}">
									<input type="hidden" name="_csrf_token" value="{{ csrf_token('nylas_folder_sync') }}">
									<div class="nylas-dropdown-new" data-dropdown="checkbox">
										<div class="nylas-dropdown-label">Select folders</div>
										<div class="nylas-dropdown-list">
											<div class="nylas-dropdown-search">
												<input type="text" class="folder-search-input" placeholder="Search folders...">
											</div>
											<div class="nylas-dropdown-option check-all-option">
												<a href="#" class="check-all-link">Select All</a>
											</div>
											{% for folder in emailFolders %}
												<label class="nylas-dropdown-option">
													<input type="checkbox" name="folders[]" value="{{ folder.folderUid }}" {% if folder.syncEnabled %} checked {% endif %}/>
													{{ folder.name }}
												</label>
											{% endfor %}
										</div>
									</div>

									<button type="submit" class="btn btn-primary mt-3" title="Save your folder sync preferences for this account. Selected folders will be synchronized during the next sync run.">
										Save Sync Preferences
									</button>
								</form>
							</div>
						{% else %}
							<div class="alert alert-info">
								No folders available for the selected email account.
							</div>
						{% endif %}
					</div>
				</div>
			{% endif %}
		</div>
	</div>
{% endblock %}

{% block head_script %}
	 <script src="{{ asset('bundles/brainstreamnylas/js/folder_list.js') }}"></script>
{% endblock %}
